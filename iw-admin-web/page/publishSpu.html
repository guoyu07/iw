<link rel="stylesheet" href="plugins/iCheck/all.css">
<div class="alert alert-warning alert-dismissable" style="display:none">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                    <h4><i class="icon fa fa-warning"></i> Alert!</h4>
                    
                  </div>
<div class="box box-primary">
  <!-- form start -->
  <div role="form" id="form">
    <div class="box-body">
      <label for="image_box">商品图片</label>
      <div class="form-group" id="image_box">

      </div>
      <div class="form-group">
        <label for="spuId">商品编码</label>
        <input id="spuId" name="spuId" type="text" class="form-control not-null" placeholder="输入 ...">
      </div>
      <div class="form-group">
        <label for="spuName">商品名称</label>
        <input id="spuName" name="name" type="text" class="form-control not-null" placeholder="输入 ...">
      </div>
      <div class="form-group">
        <label for="desc">商品描述</label>
        <textarea id="desc" name="desc" class="form-control" rows="3" placeholder="输入 ..." style="margin: 0px -1px 0px 0px; width: 467px; height: 74px;"></textarea>
      </div>
      <div class="form-group">
        <label for="color">颜色
          <div class="btn-group btn-group-xs" role="group" >
            <button type="button" id="color-add-btn" class="add-item btn btn-default  btn-group-xs" >
              <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            </button>
            <button type="button" class="del-item  btn btn-default  btn-group-xs" >
              <span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
            </button>
            
          </div>
        </label>
      </div>
      <div class="form-group">
        <label for="size">商品尺码
         <div class="btn-group btn-group-xs" role="group" >
          <button type="button" id="size-add-btn" class="add-item btn btn-default  btn-group-xs" >
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          <button type="button" class="del-item  btn btn-default  btn-group-xs" >
            <span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
          </button>
          
        </div>
      </label>
    </div>
    <div class="form-group">
      <label for="price">商品原价</label>
      <input id="price" name="price" type="text" class="form-control not-null" placeholder="单位:元">
    </div>
    <div class="form-group">
      <label for="discount">商品折扣价</label>
      <input id="discount" name="discount" type="text" class="form-control not-null" placeholder="单位:元">
    </div>
    <div class="form-group">
      <label for="count">库存数</label>
      <input id="count" name="count" type="text" class="form-control  not-null" placeholder="">
    </div>
    <div class="form-group">
      <label for="comment">备注</label>
      <textarea id="comment" name="remark" class="form-control" rows="3" placeholder="Enter ..." style="margin: 0px -1px 0px 0px; width: 467px; height: 74px;"></textarea>
    </div>

  </div><!-- /.box-body -->

</div>

<div class="box-footer">
  <button id="submit" class="btn btn-primary">发布</button>
</div>
<div id="color-add-btn-template" style="display:none"><input id="color" name="color[<index>]" type="text" class="form-control" placeholder=""></div>
<div id="size-add-btn-template" class="row" style="display:none">
  
  <div class="col-xs-8"><input id="size" name="sizeList[<index>].size" type="text" class="form-control  not-null"></div>
  <div class="col-xs-4">
    
    <span>有货</span>
            <input id="size" name="sizeList[<index>].available" value="true" type="radio" class="minimal" checked>
            <span>无货</span>
            <input id="size" name="sizeList[<index>].available" value="false" type="radio" class="minimal">
  </div>
</div>
            
            
          </div>
</div>
<script src="plugins/iCheck/icheck.min.js"></script>
<script type="text/javascript">

//iCheck for checkbox and radio inputs
$('input[type="radio"].minimal').iCheck({
  radioClass: 'iradio_minimal-blue'
});

$(".add-item").click(function(){
  var template= $("#"+$(this).attr("id")+"-template")
  var node= template.clone(true)
  node.attr("id",null)
  var container = $(this).parents(".form-group")
  var index = container.attr("index")
  if(!index){
    index=0
  }else{
    index = 1+parseInt(index)
  }
  node.find("input").each(function(){
    $(this).attr("name",$(this).attr("name").replace("<index>",index))
  })
  container.append(node)
  node.show()
  container.attr("index",index)
  $('input[type="radio"].minimal').iCheck({
    radioClass: 'iradio_minimal-blue'
  });
})

$(".del-item").click(function(){
 var container = $(this).parents(".form-group")
 var index = parseInt(container.attr("index"))
 if(index > 0){
  container.children("div:last-child").remove();
  container.attr("index", index-1)
}

})

validate = function(){
  if($("#files").find("input").length<1){
    alert("请上传图片")
    
    window.scroll(0 ,$("#files").offset().top-120)
    return false
  }

  var validateSuccess = true
  var offsetTop
  $("#form").find(".not-null").each(function(index, obj){
    var container = $(obj).parents(".form-group")
    if(container.hasClass("has-error")){
      container.removeClass("has-error")
    }
    if(!$(obj).val()){
      validateSuccess = false;
      if(!offsetTop){
        offsetTop = $(obj).offset().top-25
      }
      container.addClass("has-error")
    }
  })
  if(!validateSuccess){
    console.log(offsetTop)
    window.scroll(0 ,offsetTop)
  }
  return validateSuccess
}
$("#submit").click(function(){
  if(!validate()){
    return
  }
  var params = $("#form").toObject()
  var url = "/api/spu"
  if(params["_id"]){
    url+="/update"
  }else{
    url+="/add"
  }
  post(url,$("#form").toObject(),function(data){
    alert("添加商品成功")
  });
})


var id = getParameterByName("id")
if(id){
  post("/api/spu/findOne",{_id:id},function(data){
    $(".add-item").each(function(){
      var id = $(this).attr("id")
      var dataNode = id.substring(0,id.indexOf("-"))
      var button = $(this)
      if(data[dataNode]){
        $(data[dataNode]).each(function(){
          button.trigger("click")
        })
      }else{
        button.trigger("click")
      }

    })

    $("#image_box").load("page/upload.html",null,function(){
      var index = -1;
      $(data["images"]).each(function(index,obj){
        $("#files").append("<div><a target=\"_blank\" href=\""+obj.image+"\"><p><image width=\"100\" height=\"100\" src=\""+obj.image+"\"><br></p></a><input type=\"hidden\" name=\"images["+index+"].image\" value=\""+obj.image+"\"><input type=\"hidden\" name=\"images["+index+"].deleteUrl\" value=\""+obj.deleteUrl+"\"><button class=\"btn btn-warn\" onclick=\"deleteImage(&quot;"+obj.deleteUrl+"&quot;,this)\">Delete</button></div>")
        index += 1
      })
      $("#files").attr("index",index)
    })

    js2form("form",data)
    $("#form").append("<input type='hidden' name='_id' value='"+id+"'/>")
    $("#submit").text("更新")
  })
}else{
  $("#image_box").load("page/upload.html")
  $(".add-item").each(function(){
      var id = $(this).attr("id")
      var dataNode = id.substring(0,id.indexOf("-"))
      var button = $(this)
      button.trigger("click")
    })
}




</script>